# API для получения результатов по COVID

**Версия 3.4.4**  
>**Примечание:** Конвертирован из word

## Управление документом

| **Авторы** | ФБУН ЦНИИ Эпидемиологии, Информационно-аналитический отдел. |
| --- | --- |
| **Файл** | |
| **Создан** | 20.11.2020 |
| **Последнее редактирование** | 24.06.2021 |
| **Количество страниц** | 25 |

| **Версия** | **Дата изменения** | **Описание изменения** | **Автор изменения** |
| --- | :---: | --- | --- |
| 1.4.9 | 04.12.20 | Изменены требования к элементу serv: теперь для отправки нескольких услуг по одному заказу требуется его "разбивать" на несколько отдельных заказов. Раздел Элемент order/serv | Евстифеев Е.А. |
| 2.0.0 | 05.12.20 | Добавлены примеры построения curl-запросов и ответов на запросы. Раздел Пример запроса в curl | Евстифеев Е.А. |
| 2.0.0 | 05.12.20 | Добавлено описание методов получения статуса заявок. Описано в разделе Получение статуса обработки заявки | Евстифеев Е.А. |
| 2.0.0 | 05.12.20 | Добавлена пакетная отправка заявок. Описано в разделе Ошибка! Источник ссылки не найден. | Евстифеев Е.А. |
| 2.0.0 | 05.12.20 | Обновлены этапы тестирования работы с методами. Описано в разделе Этапы тестирования отправки заявки | Евстифеев Е.А. |
| 2.0.0 | 05.12.20 | Добавлен раздел с часто задаваемыми вопросами. Описано в разделе Часто задаваемые вопросы | Евстифеев Е.А. |
| 2.0.1 | 07.12.20 | Обновлены варианты ответа в разделе Получение статуса. Количество не полученных статусов | Евстифеев Е.А. |
| 2.0.2 | 07.12.20 | В раздел Часто задаваемые вопросы добавлены новые вопросы, связанные с ФИО гражданина РФ и нерезидентами РФ. | Евстифеев Е.А. |
| 2.0.3 | 07.12.20 | В раздел Элемент order/serv добавлен вариант результата: сомнительно. | Евстифеев Е.А. |
| 2.1.1 | 01.03.21 | Добавлены дополнительные значения поля resultЭлемент order/serv | Евстифеев Е.А. |
| 3.1.1 | 02.04.21 | Обновлено описание всех основных разделов | Евстифеев Е.А. |
| 3.2.1 | 05.04.21 | Расширено описание раздела [Отправка других типов исследований](#_%D0%9E%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0_%D0%B4%D1%80%D1%83%D0%B3%D0%B8%D1%85_%D1%82%D0%B8%D0%BF%D0%BE%D0%B2) | Евстифеев Е.А. |
| 3.2.2 | 05.04.21 | Внесен ряд уточнений, добавлены примеры | Евстифеев Е.А. |
| 3.2.5 | 07.04.21 | Добавлена возможность указания антител как IgM, так и IgG, добавлена возможность указания количественного значения | Евстифеев Е.А. |
| 3.2.6 | 08.04.21 | Добавлена возможность отправки данных по ОМС | Евстифеев Е.А. |
| 3.3.0 | 16.04.21 | В orders-package убран динамический ключ; Обновлены методы запроса статуса; Обновлен возврат № при запросе статуса; Изменен объект запроса статуса по заказам. | Самсонов А.А. |
| 3.3.2 | 14.05.21 | Добавлен четвертый тип в передачу данных: Антитела COVID, суммарное значение IgG и IgM. Ограниченно количество знаков в поле "number" до 30 знаков | Самсонов А.А. |
| 3.4.2 | 21.05.21 | Добавлено обязательное поле "readyDate" | Самсонов А.А. |
| 3.4.3 | 27.05.21 | Добавлено описание структуры пакетной отправки. Добавлен пример запроса на php (с экранированием). | Аландаров М.А. |
| 3.4.4 | 16.06.2021 | [Добавлена валидация дат (ограничение -6 месяцев +10 дней)](#_%D0%AD%D0%BB%D0%B5%D0%BC%D0%B5%D0%BD%D1%82_Order) | Самсонов А.А. |
| 3.4.4 | 24.06.2021 | [Изменение кейсов для тестирования интеграции.](#_%D0%AD%D1%82%D0%B0%D0%BF%D1%8B_%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F_%D0%BE%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B8) | Аландаров М.А. |

## Оглавление

- _**[Этапы интеграции](#_Toc69733207)**_
- _**[Получение токена](#_Toc69733208)**_  
  - **[Пример запроса в curl](#_Toc69733209)**
  - **[Пример ответа на запрос](#_Toc69733210)**
- _**[Отправка результата по COVID](#_Toc69733211)**_
  - **[Примеры запроса в curl](#_Toc69733212)**
  - **[Передача пакета заявок](#_Toc69733213)**
    - [Пример успешного ответ](#_Toc697332141)
    - [Пример неуспешного ответа (дубль номера заказа)](#_Toc69733214)
    - [Пример неуспешного ответа (неверный токен)](#_Toc69733215)
    - [Пример неуспешного ответа (неверный ЛПУ)](#_Toc69733216)
    - [Пример тело запроса](#_Toc697332161)
  - **[Отправка других типов исследований](#_Toc69733217)**
  - **[Подробное описание параметра `json`](#_Toc69733218)**
    - [Элемент `order`](#_Toc69733219)
    - [Элемент `order/serv`](#_Toc69733220)
    - [Элемент `order/patient`](#_Toc69733221)
    - [Элемент `order/address/regAddress`](#_Toc69733222)
  - _**[Получение статуса обработки заявки](#_Toc69733223)**_
  - **[Получение статуса. Количество не полученных статусов](#_Toc69733224)**
  - **[Получение статуса. Пакетное получение статусов](#_Toc69733225)**
  - **[Получение статуса. Получение статусов конкретных заявок](#_Toc69733226)**
- _**[Этапы тестирования отправки заявки](#_Toc69733227)**_
- _**[Часто задаваемые вопросы](#_Toc69733228)**_
- _**[Информация по автоматической выгрузке ПЦР-тестов на коронавирусную инфекцию на портал Госуслуг (физлица)](#_Toc69733229)**_

## Этапы интеграции

| № **п/п** | **Описание** | **Средний срок\*** | **Ответственная сторона** |
| :---: | --- | --- | --- |
| 1 | Предоставление документации по интеграционному протоколу | 2 часа | РПН |
|   | Предоставление региону тестового доступа на тестовую площадку | 2 часа | РПН |
| 2 | Анализ документации, тестирование запросов | 18 часов | Регион |
| 3 | Отправка тестового запроса | 12 часов | Регион |
| 4 | Анализ тестового запроса, предоставление рекомендаций | 2 часа | РПН |
| 5 | Исправление замечаний | 8 часов | Регион |
| 6 | Отправка запросов из системы региона в соответствии с тестовыми кейсами | 6 часа | Регион |
| 7 | Проверка запросов, предоставление рекомендаций | 2 часа | РПН |
| 8 | Исправление замечаний | 8 часов | Регион |
| 9 | Предоставление доступа к промышленной среде | 8 часа | РПН |
| 10 | Отправка 5 заказов в промышленную среду | 2 часа | Регион |
| 11 | Подтверждение готовности региона к потоковой отправке данных | 4 часа | РПН |

 Таким образом, среднее время на запуск интеграции с момента контакта ИТ-специалистов составляет 9,5 рабочих дней.  
\* указан с момента контакта между ИТ-специалистами. Указан на основании опыта подключенных регионов.

## Получение токена

>**Внимание:** Раз в 10 минут, либо перед каждой отправкой заявки необходимо запрашивать актуальный для работы `token`.

>**Примечание:** на текущий момент `token` всегда один и тот же

**Адрес:**  
/api/v2/order/get-depart-token  
**Описание:**  
method – post  
**Обязательные ключи:**  
`token` – авторизационный ключ  
`depart_number` – код в системе  
**Ответ:**
```json
"body": {
"token": "D8034D5A-DА26-69BE-600E-393453F827E4"
}
```
В ответе получаем токен, который используем для дальнейшей работы

### Пример запроса в curl
```java
curl -s -X POST 'https://domain.name/api/v2/order/get-depart-token'\
-H 'Content-Type: application/json'\
--data-raw '{"depart_number":"100000","token":"90B9FFBA-045E-4F7A-8B1C-9263384697C5"}'
```

### Пример ответа на запрос
```json
{
    "header": {
        "api": "2.0",
        "dt": "2021-04-05T17:08:45+0300",
        "latency": 9,
        "route": "/api/v2/order/get-depart-token",
        "status": "ok",
        "errors": []
    },
    "body": {
        "token": "Q049557F-333E-A9CF-8B42-20590E3EE85B"
    }
}
```
>**Внимание:** Полученное в элементе `body/token` требуется использовать для дальнейшей работы с API.

## Отправка результата по COVID

**Адрес:**  
`api/v2/order/ext-orders-package`  
**Описание:**  
method – `post`  
**Обязательные ключи:**  
`depart_number`– выдается контактным лицом со стороны ЦНИИ  
`token`– предоставляется внешним сервисом в результате обращения к `api/v2/order/get-depart-token`  
`json` – json заявки.

>**Внимание:** Передача `json` заказа должна осуществляться в UTF-8. Все поля должны существовать, даже если не заполнены.

**Структура запроса пакетной передачи данных**
```json
{
    "depart_number": "100000",
    "token": "Q049557F-333E-A9CF-8B42-20590E3EE85B",
    "json": "[{"order": {}}, {"order": {}}, {"order": {}}...]"
}
```
Рекомендуемое количество заявок в одном пакете: **50 шт**.  
>**Примечание:** нахера делать `json` текстом, сие есть великая тайна

**Пример запроса на json**
```json
{
    "depart_number": "100000",
    "token": "F76597A1-601F-A732-5D9E-C6F5302A5FA3",
    "json": "[{\"order\": {\"number\": \"TEST1\", \"depart\": \"100434\", \"laboratoryName\": \"ООО ТЕСТ\",
 \"laboratoryOgrn\": \"1183443000146\", \"name\": \"ТЕСТ\", \"ogrn\": \"00000000000\", \"orderDate\": \"2021-05-24\",
 \"serv\": [{\"code\": \"13001\", \"name\": \"ТЕСТ\", \"testSystem\": \"\", \"biomaterDate\": \"2021-05-24\", \"result\": 0,
 \"type\": 1, \"value\": 0}], \"patient\": {\"surname\": \"ТЕСТОВ\", \"name\": \"ТЕСТ\", \"patronymic\": \"ТЕСТОВИЧ\",
 \"gender\": 1, \"birthday\": \"1969-07-04\", \"phone\": \"1234567890\", \"email\": \"\",
 \"documentType\": \"Паспорт гражданина РФ\", \"documentNumber\": \"111111\", \"documentSerNumber\": \"1122\",
 \"snils\": \"11111111111\", \"oms\": \"1111111111111111\", \"address\": {\"regAddress\": {\"town\": \"\", \"house\": \"\",
 \"region\": \"Волгоградская область\", \"building\": \"\", \"district\": \"\", \"appartament\": \"\", \"streetName\": \"\"},
 \"factAddress\": {\"town\": \"\", \"house\": \"\", \"region\": \"Волгоградская область\", \"building\": \"\",
 \"district\": \"\", \"appartament\": \"\", \"streetName\": \"\"}}}}}]"
}
```

### Примеры запроса в curl.

В примере используется тестовый параметр `depart_number` и призван показать принцип формирования пакетных запросов.
```scss
curl -s -X POST 'https://domain.name/api/v2/order/ext-orders-package'\
-H 'Content-Type: application/json'\
--data-raw "{\"token\": \"5D779458-E9BA-8B18-1A80-E92469EA62E9\",\"depart_number\": \"999999\",
\"json\":\"[{\"order\":{\"number\":\"DFFTL5\",\"depart\":\"999999\",
\"laboratoryName\":\"ФБУН ЦНИИ ЭПИДЕМИОЛОГИИ РОСПОТРЕБНАДЗОРА\",\"laboratoryOgrn\":\"1027700046615\",
\"nameMo\":\"ЦНИИЭ Роспотребнадзора\",\"ogrn\":\"1027700046615\",\"orderDate\":\"2021-04-01\",
\"serv\":[{\"code\":\"170117\",\"name\":\"РНК SARS-CoV-2 (COVID-19), качественное определение\",
\"testSystem\":\"РЗН 2014\/1987\",\"biomaterDate\":\"2021-04-01\",\"readyDate\": \"2021-05-20\",
\"result\":0 ,\"type\":1}],\"patient\":{\"birthday\":\"1950-09-06\",\"phone\":\"0003110372\",
\"email\\":\"test50@mail.ru\",\"documentType\":\"Паспорт гражданина РФ\",\"documentNumber\":\"\",
\"documentSerNumber\":\"\",\"snils\":\"\",\"oms\":\"\",\"address\":{\"regAddress\":{\"town\":\"Москва\",
\"house\":\"1\",\"state\":null,\"region\":\"Москва\",\"building\":null,\"district\":null,
\"appartament\":\"1\",\"streetName\":\"13яПарковая\"},\\"factAddress\":{\"town\":\"Москва\",
\"house\":\\"25\",\"state\":null,\"region\":\"Москва\",\"building\":\"1\",\"district\":null,
\"appartament\":\"93\",\"streetName\":\"13яПарковая\"}}}}},{\"order\":{\"number\":\"DFFTL4\",
\"depart\":\"999999\",\"laboratoryName\":\"ФБУНЦНИИЭПИДЕМИОЛОГИИРОСПОТРЕБНАДЗОРА\",\"laboratoryOgrn\":\"1027700046615\",
\"nameMo\":\"ЦНИИЭРоспотребнадзора\",\"ogrn\":\"1027700046615\",\"orderDate\":\"2021-04-01\",
\"serv\":[{\"code\\":\"170117\",\"name\":\"РНК SARS-CoV-2 (COVID-19), качественноеопределение\",
\"testSystem\":\"РЗН 2014\/1987\",\"biomaterDate\":\"2021-04-01\",\"result\":0 ,\"type\":2 ,\"value\":0.16}],
\"patient\":{\"surname\":\"Тест\",\"name\":\"Тест\",\"patronymic\":\"Тест\",\"gender\":2,\"birthday\":\"1950-09-06\",
\"phone\":\"0003110372\",\"email\":\"test50@mail.ru\",\"documentType\":\"ПаспортгражданинаРФ\",\"documentNumber\":\"\",
\"documentSerNumber\":\"\",\"snils\":\"\",\"oms\":\"\",\"address\":{\"regAddress\":{\"town\":\"Москва\",\"house\":\"1\",
\"state\":null,\"region\":\"Москва\",\"building\":null,\"district\":null,\"appartament\":\"1\",
\"streetName\":\"13яПарковая\"},\\"factAddress\":{\"town\":\"Москва\",\"house\":\"25\",\"state\":null,
\"region\":\"Москва\",\"building\":\"1\",\"district\":null,\"appartament\":\"93\",\"streetName\":\"13яПарковая\"}}}}}]\"}"
```

### Передача пакета заявок.

Для пакетной отправки необходимо несколько заявок поместить в массив, разделив запятой:
```json
[{
    "order": {
        "number": "TEST-001",
        "depart": "100000",
        "laboratoryName": "Лаборатория-исполнитель",
        "laboratoryOgrn": "00000000000",
        "name":"Название организации",
        "ogrn":"00000000000",
        "orderDate": "2020-11-03",
        "serv": [],
        "patient": {}
    }
},
{
    "order": {
        "number": "TEST-002",
        "depart": "100000",
        "laboratoryName": "Лаборатория-исполнитель",
        "laboratoryOgrn": "00000000000",
        "name":"Название организации",
        "ogrn":"00000000000",
        "orderDate": "2020-11-03",
        "serv": [],
        "patient": {}
    }
}]
```

#### Пример успешного ответа.
```json
{
    "header": {
        "api": "2.0",
        "dt": "2021-04-15T15:10:21+0300",
        "latency": 22,
        "route": "/api/v2/order/ext-orders-package",
        "status": "ok",
        "errors": []
},
    "body": [
    {
        "number": "DFFTL3",
        "status": "ok",
        "id": 290621
    },
    {
        "number": "DFFTL4",
        "status": "ok",
        "id": 290622
    }]
}
```
В элементе `body/status` представлен результат выполнения запроса. Ответ, отличный от "ok" требует дальнейшего анализа заявки и ее повторной отправки.  
>**Примечание:** нифига ответ другой (походу это уже старая версия), к тому же есть комент разрабов:
>>_Вы не сможете полностью повлиять на ошибку "PASSPORT_NOT_FOUND", т.к. один из возможных вариантов получения данной ошибки, это не подтвержденная учетная запись пациента_

#### Пример неуспешного ответа (дубль номера заказа)
```json
{
    "header": {
        "api": "2.0",
        "dt": "2021-04-15T15:10:21+0300",
        "latency": 22,
        "route": "/api/v2/order/ext-orders-package",
        "status": "ok",
        "errors": []
    },
    "body": [
    {
        "number": "DFFTL5",
        "status": "ok",
        "id": 344419
    },
    {
        "number": "DFFTL4",
        "status": "error",
        "id": null,
        "message": "Данный номер заказа 'DFFTL4' уже был использован. Укажите уникальный номер!"
    }]
}
```

#### Пример неуспешного ответа (неверный токен)
```json
{
    "name": "BadRequest",
    "message": "Токен доступа данного ЛПУ не верный.",
    "code": 0,
    "status": 400,
    "type": "yii\\web\\BadRequestHttpException"
}
```

#### Пример неуспешного ответа (неверный ЛПУ)
```json
{
    "name": "BadRequest",
    "message": "Данный ЛПУ 999999 не совпадает с указанным в файле json – 99999",
    "code": 0,
    "status": 400,
    "type": "yii\\web\\BadRequestHttpException"
}
```
#### Пример тела запроса.
```json
[{
    "order": {
        "number": "указать свой уникальный номер заявки",
        "depart": "100000",
        "laboratoryName": "Лаборатория-исполнитель",
        "laboratoryOgrn": "00000000000",
        "name":"Название организации",
        "ogrn":"00000000000",
        "orderDate": "2020-11-03",
        "serv": [{
            "code": "170114",
            "name": "РНК SARS-CoV-2 (COVID-19), качественное определение",
            "testSystem": "РЗН 2014/1987",
            "biomaterDate": "2020-11-03",
            "readyDate": "2020-11-07",
            "result": 0,
            "type": 1
        }],
        "patient": {
            "surname": "Прищепо",
            "name": "Людмила",
            "patronymic": "Николаевна",
            "gender": 2,
            "birthday": "1953-12-14",
            "phone": "9261234567",
            "email": "email@address.ru",
            "documentType": "Паспорт гражданина РФ",
            "documentNumber": "553320",
            "documentSerNumber": "1902",
            "snils": "48095351208",
            "oms": "123456789",
            "address": {
                "regAddress": {
                    "town": "рег_город",
                    "house": "рег_дом",
                    "region": "Московская область",
                    "building": "рег_строение",
                    "district": "рег_район",
                    "appartament": "рег_квартира",
                    "streetName": "рег_улица"
                },
                "factAddress": {
                    "town": "факт_город",
                    "house": "факт_дом",
                    "region": "Московская область",
                    "building": "факт_строение",
                    "district": "факт_район",
                    "appartament": "факт_квартира",
                    "streetName": "факт_улица"
                }
            }
        }
    }
}]
```
>**Внимание:** Примеры реализации запросов на curl, Delphi, php, 1C могут быть предоставлены по запросу

### Отправка других типов исследований

Шлюз позволяет обрабатывать другие типы исследований, в т.ч. антитела. Для этого в массиве:
```json
"serv": [{
    "code": "170114",
    "name": "РНК SARS-CoV-2 (COVID-19), качественное определение",
    "testSystem": "РЗН 2014/1987",
    "biomaterDate": "2020-11-03",
    "readyDate": "2020-11-07",
    "result": 0
}],
```
Требуется добавить параметр `serv/type` с соответствующим значением, а также значение самого результата.  
В случае, если исследование по умолчанию является количественным, то в блоке `value` необходимо указать значение теста:
```JSON
"serv": [{
    "code": "044750",
    "name": "Антитела SARS-CoV-2 (COVID-19), качественное определение",
    "testSystem": " ",
    "biomaterDate": "2020-11-03",
    "readyDate": "2020-11-07",
    "result": 0,
    "type": 2,
    "value": 0.6
}],
```
Если параметр не указывать, то по умолчанию тип определяется как РНК SARS-CoV-2 (COVID-19), качественное определение.

Таблица доступных типов исследований:

| **Тип** | **Наименование** |
| :---: | --- |
| 1 | ПЦР COVID, качественное |
| 2 | Антитела COVID, качественное IgG |
| 3 | Антитела COVID, качественное IgM |
| 4 | Антитела COVID, суммарное значение IgG и IgM |

Дополнительная информация: [ссылка](#_%D0%A7%D0%B0%D1%81%D1%82%D0%BE_%D0%B7%D0%B0%D0%B4%D0%B0%D0%B2%D0%B0%D0%B5%D0%BC%D1%8B%D0%B5_%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81%D1%8B)  
>**Примечание:** мы испльзуем только первый тип: ПЦР COVID, качественное

### Подробное описание параметра `json`

#### Элемент `order`

Данный элемент маркирует тип сообщения – передача заказа. Внутри элемента `order` передаются все элементы заявки.

>**Внимание:** Все элементы должны присутствовать. Даже если каких-то данных нет, наличие параметра обязательно.

| **Наименование элемента** | **Тип данных** | **Обяза-тельность** | **Описание** |
| --- | --- | :---: | --- |
| `number` | varchar(40) | ДА | Номер заказа. Используется для идентификации запроса. Номер запроса должен быть уникальным. Даже в рамках тестирования нужно обеспечить уникальность номера заказа. Для тестирования можно использовать нумерацию: TEST-001. Должен быть не длиннее 30 символов. |
| `depart` | varchar(40) | ДА | Код региона (выдается принимающей стороной), используется для идентификации заказа в паре с его номером. |
| `laboratoryName` | varchar(200) | ДА | Лаборатория-исполнитель (организация, выполняющая лабораторное исследование). Символы « заменять на ", либо на пустоту. |
| `laboratoryOgrn` | varchar(40) | ДА | ОГРН лаборатории-исполнителя |
| `name` | varchar(200) | ДА | Название организации-заказчика, направившей заказ на лабораторное исследование. Символ « заменять на ", либо на пустоту. |
| `ogrn` | varchar(40) | ДА | ОГРН организации-заказчика |
| `orderDate` | varchar(40) | ДА | Дата заказа, в формате ГГГГ-ММ-ДД (ограничение -6 месяцев +10 дней) |

#### Элемент `order/serv`

>**Внимание:** Для корректности обработки результатов требуется каждую услугу отправлять отдельным запросом.

>**Пример:**
>Имеется уникальный заказ A00101 с 2 услугами на COVID: **serv1** и **serv2**  
>Для передачи на портал ГОСУСЛУГИ требуется отправить 2 аналогичных `json:`  
>  1. Заказ A00101-1 с услугой **serv1**  
>  2. Заказ A00101-2 с услугой **serv2**
> 
>Остальные параметры остаются идентичными в заказах.

| **Наименование элемента** | **Тип данных** | **Обяза-тельность** | **Описание** |
| --- | --- | :---: | --- |
| `code` | varchar(40) | ДА | Код заказываемой услуги, в примере 170114. Указывается в соответствии со справочником лаборатории-исполнителя. |
| `name` | varchar(200) | ДА | Название услуги. Указывается в соответствии со справочником лаборатории-исполнителя. |
| `testSystem` | varchar(200) | НЕТ | Тип сертифицированной тест-системы. Заполняется как строковое значение, единого справочника нет. Например: РЗН 2014/1987 Пример перечня сертифицированных тест-систем (по состоянию на 24.07.2020): http://рспп.рф/events/news/perechen-test-sistem-dlya-vyyavleniya-koronavirusnoy-infektsii/ |
| `biomaterDate` | varchar(40) | ДА | Дата взятия биоматериала, в формате ГГГГ-ММ-ДД |
| `readyDate` | varchar(40) | ДА | Дата готовности результата исследования, в формате ГГГГ-ММ-ДД (ограничение -6 месяцев +10 дней) |
| `result` | int | ДА | 0 – не обнаружено; 1 – обнаружено; 2 – сомнительно; 3 – брак; |
| `type` | int | НЕТ | Значение в соответствии с таблицей [Отправка других типов исследований](#_%D0%9E%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0_%D0%B4%D1%80%D1%83%D0%B3%D0%B8%D1%85_%D1%82%D0%B8%D0%BF%D0%BE%D0%B2) . Если параметр не указан или не заполнен – считает значение 1. |
| `value` | float | НЕТ | Значение результата. В случае, если выполняется количественное исследование, то значение результата указывается в этом поле. |

<span style="color:red">**Важно!!!**</span>  
<span style="color:red">В поле `result` возможен вариант результата "сомнительно" и "брак".</span>  
<span style="color:red">Но такие запросы **не будут переданы в ГОСУСЛУГИ.**</span>  
Заявки с такими результатами нужны исключительно для нужд РПН и последующей аналитики.

#### Элемент `order/patient`

Содержит информацию по пациенту.

| **Наименование элемента** | **Тип данных** | **Обяза-тельность** | **Описание** |
| --- | --- | :---: | --- |
| **surname** | varchar(200) | ДА | Фамилия (в случае отсутствия данных – оставлять пустым) |
| **name** | varchar(40) | ДА | Имя пациента (в случае отсутствия данных – оставлять пустым) |
| **patronymic** | varchar(40) | ДА | Отчество (при наличии в паспорте) |
| **gender** | integer | ДА | Пол: ("1" - муж, "2" - жен) |
| **birthday** | varchar(10) | ДА | Дата рождения, в формате ГГГГ-ММ-ДД |
| **phone** | varchar(10) | НЕТ | Телефон, в формате 10 цифр. Пример: 9261234567. В случае, если поле "номер телефона" не стандартизировано, рекомендуется удалить все лишние символы, оставив последние 10 цифр номера. Таким образом, номер формата 8 (926) 123-45-67 будет преобразован в 9261234567.|
| **Email** | varchar(40) | НЕТ | Адрес электронной почты |
| **documentType** | varchar(25) | ДА | Передается строковое значение (строго из списка):
- Паспорт гражданина РФ
- Свидетельство о рождении
- Вид на жительство
- Заграничный паспорт

Портал Госуслуги рекомендует в качестве приоритетного использовать: **Паспорт гражданина РФ**. Для него нужно сделать маску по полям: **documentSerNumber** ХХХХ **documentNumber** ХХХХХХ
Для **Заграничного паспорта (именно Заграничный паспортаРФ – не путать с паспортом иностранного гражданина)** сделать маску: **documentSerNumber** ХХ **documentNumber** ХХХХХХХ
Для **Свидетельства о рождении** сделать маску серии: **documentSerNumber** одна латинская цифра (III/V/X) дефис (две русские буквы)
Для всех остальных случаев сделать ещё два типа документа "Паспорт иностранного гражданина" и "Иное" без маски.
Со стороны региона необходимо жестко контролировать заполнение варианта "Иное" и избегать случаев использования данного значения тогда, когда этого можно не допускать. |
| **documentNumber** | varchar(40) | ДА | Номер документа. Формат заполнения зависит от типа документа. |
| **documentSerNumber** | varchar(40) | ДА | Серия документа Формат заполнения зависит от типа документа. |
| **snils** | varchar(11) | ДА | СНИЛС (значение указывается без пробелов). 11 знаков. |
| **oms** | varchar(16) | ДА | В поле передается значение полиса ОМС.Старый образец: 16 знаков, из которых 6 знаков – серия, 10 цифр – номер, значение передается слитно: ABCDEF1234567890Новый образец: 16 знаков без пробелов: 1234567890123456Временное свидетельство: 9 цифр без пробелов:123456789 |

**Если ФИО или часть ФИО определить невозможно – данные требуется оставлять пустыми. В случае, если пациент идентифицирован – данные передавать обязательно.**

**Обязательно обеспечить корректность заполнения информации:**

- **ОМС и/или СНИЛС и/или: Тип документа + Номер документа + Серия документа.**
- **ФИО.**
- **Дата рождения.**
- **Пол.**

**Эти данные – основа для идентификации гражданина РФ в системе.**

### Элемент **patient**  **/**** address ****/**** regAddress**

**Все указанные поля должны присутствовать. В случае, если данных нет – оставлять пустое значение, либо**  **null****. В случае, если все поля пустые, в поле **** region **** нужно передать название региона. Например, "Московская область", либо "Республика Татарстан".**

| **Наименование элемента** | **Тип данных** | **Обязательность** | **Описание** |
| --- | --- | --- | --- |
| **town** | varchar(200) | НЕТ | Город (третий уровень классификации, в т.ч. города и поселки городского типа регионального и районного подчинения; сельсоветы (сельские округа, сельские администрации, волости)), строковое значение |
| **house** | varchar(200) | НЕТ | Номер дома, строковое значение (шестой уровень классификации) |
| **region** | varchar(200) | НЕТ | Субъект РФ (область, край, республика, округ, город федерального значения). Первый уровень классификации. |
| **building** | varchar(200) | НЕТ | Строение |
| **district** | varchar(200) | НЕТ | Район (административная единица – второй уровень классификации) |
| **appartament** | varchar(200) | НЕТ | Квартира |
| **streetName** | varchar(200) | НЕТ | Название улицы (пятый уровень классификации) |

Элемент **patient**** / ****address**** / ****factAddress**

**Все указанные поля должны присутствовать. В случае, если данных нет – оставлять пустое значение, либо**  **null****. В случае, если все поля пустые, в поле **** region **** нужно передать название региона. Например, "Московская область", либо "Республика Татарстан".**

| **Наименование элемента** | **Тип данных** | **Обязательность** | **Описание** |
| --- | --- | --- | --- |
| **town** | varchar(200) | НЕТ | Город (третий уровень классификации, в т.ч. города и поселки городского типа регионального и районного подчинения; сельсоветы (сельские округа, сельские администрации, волости)), строковое значение |
| **house** | varchar(200) | НЕТ | Номер дома, строковое значение (шестой уровень классификации) |
| **region** | varchar(200) | НЕТ | Субъект РФ (область, край, республика, округ, город федерального значения). Первый уровень классификации. |
| **building** | varchar(200) | НЕТ | Строение |
| **district** | varchar(200) | НЕТ | Район (административная единица – второй уровень классификации) |
| **appartament** | varchar(200) | НЕТ | Квартира |
| **streetName** | varchar(200) | НЕТ | Название улицы (пятый уровень классификации) |

# **Получение статуса обработки заявки**

Получение статуса обработки заявки необходимо для дальнейшей работы над улучшением качества распознавания граждан РФ. Чем выше качество данных (в т.ч. на этапе регистрации), тем лучше идентификация гражданина приложением.

**Описание:**

method – post

**Обязательные ключи:**

_token_ – предоставляется внешним сервисом

_depart __\___ number_ – номер, идентифицирующий передающую сторону

Используется 3 способа получения статусов по заявкам:

##

## Получение статуса. Количество не полученных статусов

Позволяет получить информацию по количеству заявок, готовых внешней системой к отправке. Запрос рекомендовано выполнять раз в промежуток времени (например, 10 минут). В случае, если значение больше 0, запускать процедуру получения статусов заявок.

Пример запроса:

curl -s -XPOST'https://domain.name/api/v2/order/status-count' \

-H 'Content-Type: application/json' \

--data-raw '{"depart\_number":"100000","token":"90B9FFBA-045E-4F7A-8B1C-9263384697C5"}'

Примерответа:

{

"header": {

"api": "2.0",

"dt": "2021-04-16T17:10:21+0300",

"latency": 233,

"route": "/api/v2/order/status-count",

"status": "ok",

"errors": []

},

"body": {

"status": "ok",

"count": 34

}

}

Данный ответ означает, что у вас 34 новых, ранее не запрашиваемых вами статусов.

Полученное значение используется для дальнейшего запроса статусов по заявкам.

## Получение статуса. Пакетное получение статусов.

Позволяет получить статусы данных заявок.
 Тут добавляется ключ "count"

curl -s -XPOST'https://domain.name/api/v2/order/new-status \

-H 'Content-Type: application/json' \

--data-raw '{"depart\_number":"100000","token":"90B9FFBA-045E-4F7A-8B1C-9263384697C5", "count": 34}'

Примерответа:

{

"header": {

"api": "2.0",

"dt": "2021-04-16T17:10:21+0300",

"latency": 233,

"route": "/api/v2/order/new-status",

"status": "ok",

"errors": []

},

"body": {

"status": "ok",

"count": 100,

"data": {

"orders": [{

"id": 45875,

"number": "TEST-001",

"status": true,

"error": ""

},

{

"id": 45876,

"number": "TEST-002",

"status": delivered\_error,

"error": "Не заполнены необходимые параметры: СНИЛС, паспортные данные, контактные данные"

},

{

"id": null,

"number": "TEST-003",

"status": null,

"error": "Заявка в системе не обнаружена, повторите отправку"

}]

}

}

В случае, если указано количество заявок больше, чем количество неотправленных статусов, то высылается столько статусов заявок, сколько осталось не отправлено.

count – количество отправляемых в ответе статусов.

data / orders – массив, в котором содержатся отправляемые заявки.

id – идентификатор заявки в системе

number – номер заявки, отправленный ранее

status – статус заявки. received – получена, null – не найдена, send\_error - отправлена, но в ответ получена ошибка, delivered\_ok – доставлена, пациент найден, delivered\_error – доставлена, пациент не найден.

error – описание возникшей ошибки.

**Ограничения. Данный запрос разрешено отправлять не чаще 1 раза в 1 минуту. В поле**  **count**  **допустимо значение от 0 до 500.**

Получение статуса. Получение статусов конкретных заявок.

В некоторых случаях может потребоваться получить информацию по статусам конкретных заявок.

Пример запроса:

curl -s -XPOST'https://domain.name/api/v2/order/status-by-orders\

-H 'Content-Type: application/json' \

--data-raw '{"depart\_number":"100000","token":"90B9FFBA-045E-4F7A-8B1C-9263384697C5", "orders": ["TEST-001","TEST-002","TEST-003"]}'

{

"header": {

"api": "2.0",

"dt": "2021-04-05T17:10:21+0300",

"latency": 233,

"route": "/api/v2/order/status-by-orders",

"status": "ok",

"errors": []

},

"body": {

"status": "ok",

"count": 100,

"data": {

"orders": [{

"id": 45875,

"number": "TEST-001",

"status": delivered\_ok,

"error": ""

},

{

"id": 45876,

"number": "TEST-002",

"status": delivered\_error,

"error": "Не заполнены необходимые параметры: СНИЛС, паспортные данные, контактные данные"

},

{

"id": null,

"number": "TEST-003",

"status": null,

"error": "Заявка в системе не обнаружена, повторите отправку"

}]

}

}

В случае, если в запросе присутствовали заявки, отсутствующие в системе, система об этом сообщит. Такие заявки требуется повторно отправить, либо обратить внимание на ответ при их отправке (возможно, в заявке присутствуют ошибки).

count – количество отправляемых в ответе статусов.

data / orders – массив, в котором содержатся отправляемые заявки.

id – идентификатор заявки в системе

number – номер заявки, отправленный ранее

status – статус заявки. Допустимые значения:true– заявка успешно создала справку,false– заявка не смогла создать справку,null– заявка не найдена в системе

error – описание возникшей ошибки.

# Этапы тестирования отправки заявки

В рамках запуска интеграции система должна пройти следующие этапы тестирования.

1. Добиться получения токена и успешной отправки json через используемый инструмент отладки API (например, postman или аналоги) в рамках взаимодействия с тестовой средой, предоставленной РПН.
2. Настроить систему отправки запросов с тестового сервера на тестовую среду РПН.
3. Отправить следующие типы запросов:

  1. Используется и заполнена информация о паспорте РФ (серия/номер), СНИЛС и ОМС. Заполнены контактные данные (телефон и email)
  2. Результат ПЦР теста отрицательный.
  3. Результат ПЦР теста положительный
  4. Результат антител (IgG или IgM) качественный положительный
  5. Результат антител (IgG или IgM) качественный отрицательный
  6. Результат антител (IgG или IgM) количественный.

По каждому кейсу отправлены номера заказов для их идентификации и проверки на корректность в виде:

**Номер кейса -\&gt; Номер заявки.**

**Пример:**

**Кейс 1 – заявка №**  **D**** 000031, Кейс 2 – заявка № **** D ****000032**

# Часто задаваемые вопросы

1. **Какие запросы для чего используются?**

Запрос **Получение токена** необходим для получения временного токена, позволяющего осуществлять отправку заявок.

Запрос **Отправка результата по COVID** необходим непосредственно для формирования запроса в сервис ГОСУСЛУГИ.

Запрос **Получение статуса обработки заявки** необходим для получения статуса отправки запроса и создания справки на сервисе ГОСУСЛУГИ.

1. **Чем отличается тестовая среда от продуктивной?**

В тестовой среде Вы можете создавать заявки и быть уверенными, что они не уйдут в продуктивную среду. Вместе с тем в тестовой среде используются такие же алгоритмы и проверки, как и в продуктивной. Обновления на тестовую среду накатываются в режиме hot-fix.

1. **Что такое**  **order?**

Order – это заказ / заявка / направление (в различных системах используются различные термины). У нее есть номер, позволяющий идентифицировать среди других заявок.

1. **Зачем нужна уникальность заявок?**

Уникальность заявки обеспечивает 100% идентификацию каждого запроса на всех этапах ее обработки. Каждая заявка после ее получения на продуктивной среде уходит в работу на сервисе ГОСУСЛУГИ. Никакие изменения на продуктивной среде ГОСУСЛУГ невозможны и события, требующие таких изменений, решаются в частном порядке. В этой связи повторная отправка заявки под тем же номером исключена. В случае необходимости повторной отправки заявки данный вопрос требуется обсудить с принимающей стороной и получить соответствующие рекомендации.

1. **Можно ли в рамках одной заявки отправить несколько услуг?**

Нет, сервис ГОСУСЛУГ не допускает отправку в одной заявки нескольких услуг.

1. **Помимо результата "обнаружено" и "не обнаружено" у нас имеется результат "сомнительно". Что передавать в этом случае?**

Результат "сомнительно" для задач сервиса ГОСУСЛУГ является бесполезным. Такие результаты передавать нужно, но данная информация будет использована исключительно для нужд РПН и последующей аналитики. Справка по такому типу результата создана не будет.

1. **А для чего вообще нужна интеграция?**

Алгоритм применения данных, полученных по протоколу интеграции, можно увидеть по ссылке: [https://yadi.sk/i/eMPiG5D1m32Twg](https://yadi.sk/i/eMPiG5D1m32Twg)

1. **Можно ли вместо имени и отчества передавать инициалы?**

Да, это допустимо. Однако в случае наличия полных данных важно их передавать.

1. **У пациента нет отчества. Что делать?**

Если у пациента действительно не отчества (даже в паспорте)- оставляйте его пустым. Ведь это его паспортные данные и у него действительно нет отчества. Тогда передавайте просто Фамилию и Имя.

Однако в противном случае – если эти данные присутствуют – необходимо обеспечить корректность заполнения сведений полностью – Фамилия, Имя и Отчество.

1. **К нам поступил пациент в бессознательном состоянии. Как его вам передать?**

Т.к. его нельзя на данный момент идентифицировать, то справка сформирована не будет. Однако информацию передавать все равно требуется для учета таких пациентов в статистике.

1. **Обязательно ли передавать адрес проживания и адрес регистрации?**

В случае наличия этих данных в потоке первичной информации, полученной при регистрации заявки, передача их обязательна. В случае, если данные отсутствуют, необходимо передать как минимум регион (область, край) взятия б/м. Это крайне важно для дальнейших мероприятий по положительным результатам.

1. **У нас есть заявки на пациентов-нерезидентов РФ. Вам их передавать?**

Данные заявки не будут распознаны в ГОСУСЛУГАХ как справки, т.к. на сервисе нет граждан других стран. Вместе с тем эти данные в дальнейшем уходят в центральный РПН, поэтому передавать такие заявки нужно передавать.

1. **Почему важно обеспечивать максимальное качество заполнения данных?**

Это критически важно для распознавания заявки и генерации на ее основе справки в сервисе ГОСУСЛУГИ. Отсутствие справки по конкретной заявки в дальнейшем может привести к сложностям коммуникаций с государственными структурами, требующими наличия данной справки.

1. **В разделе "Передача пакета заявок" описан алгоритм пакетной работы. Зачем передавать несколько заявок в одном запросе?**

Это необходимо для минимизации количества сессий между сервисами. Данный алгоритм является приоритетным.

1. **У меня не получается реализовать Вашу**  **API****. Что я не так делаю?**

Причин может быть множество. Мы рекомендуем внимательно проверить качество заполнения json, для этого обратиться к разделу

Отправка результата по COVIDданного документа. Также можно запросить примеры реализации на различных языках программирования, либо обратиться за помощью к специалистам с принимающей стороны для совместного решения возникших проблем.

1. **На основании чего мы должны передавать вам данные?**

В соответствии с вышедшим постановлением Правительства РФ каждая лаборатория обязана предоставлять информацию обо всех выполненных исследованиях [https://yadi.sk/d/r4XUe\_GC0lSjkg](https://yadi.sk/d/r4XUe_GC0lSjkg)

1. **В ТЗ тест на антитела качественный, однако у нас в системе – количественный. Как быть?**

На основании Ваших референсных значений требуется определить: обнаружено или не обнаружено и передать значение как качественное.

1. **Как передавать результаты исследований у пациентов, у которых по тем или иным причинам нет документов, а также неизвестны ФИО.**

Результаты анализов таких пациентов передаются с указанием ФИО, как "Неизвестный", данные документов не указываются (поля остаются пустые), указывается только регион.

1. **Нужно ли передавать количественные результаты? Каким образом преобразовывать в качественные?**

У каждой лаборатории свои референсные значения в зависимости от используемой тест-системы. В этой связи лаборатория должна на основании своих референсных значений определить, обнаружено или не обнаружено. Соответственно результат, который Вы нам передадите в поле result: 0 или 1. Далее в поле value нужно записать количественное значение данного теста.

# Информация по автоматической выгрузке ПЦР-тестов на коронавирусную инфекцию на портал Госуслуг (физлица).

| **Вопросы путешественников** |
| --- |
| С какой даты не надо загружать информацию на Госуслуги? | Загружать информацию нужно. Пока не придет результат анализа на Covid-19, соблюдайте режим самоизоляции. |
| Если не загрузить, то штрафа не будет? | штраф от 15000 до 40000 рублей по ч. 2 ст. 6.3 КоАП РФ. |
| С какой даты не надо загружать? | Загружать нужно. Пока не придет результат анализа на коронавирус, соблюдайте режим самоизоляции. |
| "Это правило для всех регионов? Если для части, то какие регионы?" | Правило распространяется на все регионы |
| Прилетел из-за границы в Москву и следую в другой город, тест сдал в аэропорту в Москве. Нужно ли загружать результаты? | Результаты загружать нужно в течение трех дней.
 Если пассажир живет в другом регионе и возвращается из-за рубежа с пересадкой в Москве, он не обязан оставаться в столице до получения результата анализа. Турист может добраться до другого города самолетом или поездом и самоизолироваться дома. |
| Прилетел из-за границы в Москву и следую в другой город, тест сдал в своем городе. Нужно ли загружать результаты? | Результаты загружать нужно в течение трех дней. |
| На портале Госуслуг по постановлению 7 необходимо заполнять 2 услуги: до вылета и после прилета и получения теста. Нужно ли заполнять эти госуслуги (анкеты): обе, первую, вторую, заполнять не надо? | Необходимо заполнять обе услуги. Порядок и ссылки на услуги указаны в ответе на вопрос №1. |
| В лаборатории ничего не сказали по поводу того, что не надо загружать тест. Где узнать перечень лабораторий, которые передают результаты в Госуслуги сами? Что делать, если клиники (лаборатории) нет в списке? | Сейчас нужно самому контролировать процесс загрузки и своевременно мониторить. В последствии все лаборатории и медцентры будут загружать результаты COVID-тестов сразу на ЕПГУ. |
| Будут ли тесты детей, которые едут в сопровождении родителей подгружаться на портал Госуслуг? | Будут. Пользователям приходит уведомление в ГЭПС (Госпочта) и push следующего содержания: Результаты вашего теста на Covid-19 готовы и доступны в приложении "Госуслуги СТОП Коронавирус".Открыть результаты в приложении для iOS или Android, а также по ссылке. Т.е. уведомление приходит, но, чтобы увидеть сами результаты надо перейти в приложение. |
| Где сдать ПЦР-тест по возвращению из-за границы | В аэропортах. Путешественники могут сдать экспресс-тест по прилете — в Домодедово, Шереметьево и Внуково. |
|
 |
 |
| **Вопросы юр. лиц** |
| Кто подключается | К платформе подключаются юридические лица (лаборатории фактически осуществляющие лабораторные исследования), осуществляющие ПЦР-исследования на наличие COVID-19 и анализ на антитела к коронавирусной инфекции, независимо от организационно-правовой формы.
Пункт 2 Постановления Правительства РФ 27 марта 2021 года №452: "Организациям независимо от их организационно-правовых форм, осуществляющим исследования на наличие возбудителя новой коронавирусной инфекции (COVID-19) методом полимеразной цепной реакции, на наличие антител к возбудителю новой коронавирусной инфекции (COVID-19) (любым из методов), на наличие антител после вакцинации путем определения специальными тестами, при наличии согласия физического лица обеспечить передачу…." |
| Почему мы еще не подключены | Технологическая платформа создана и апробирована на 16-ти пилотных регионах. Лаборатории этих регионов уже осуществляют передачу данных. Остальные находятся в стадии подключения. |
| Сколько длится подключение | Скорость подключения региона или лаборатории – от нескольких дней до месяца. |
| Алгоритм подключения | Федеральные лаборатории подключаются централизованно, через наш институт. Региональные лаборатории осуществляют передачу данных через территориальные подразделения Роспотребнадзора. Территориальное подразделение РПН собирает данные по своему региону и передаёт их централизованно во ФБУН ЦНИИЭ РПН. |
| Можно ли подключиться напрямую через ЦНИИЭ | Медицинские учреждения подключаются в порядке очередности обращения и готовности к подключению со своей стороны. Ограничений на подключения нет. Подключение осуществляется и при получении данных от РПН, и при прямом обращении в ЦНИИЭ. |
| Хотим подключиться напрямую через ЦНИИЭ/остались вопросы | Координирует работу с медучреждениями и сможет ответить на дополнительные вопросы Самсонов Александр 8-916-570-82-29 |
| Как нам получить согласие на передачу данных от пациента? | Вы можете включить в ваш договор на оказание медицинских услуг следующий текст либо сделать доп. соглашение на официальном бланке:

 В соответствии с п. 3 ст. 13 ФЗ от 21.11.2011 г. № 323-ФЗ "Об основах охраны здоровья граждан в Российской Федерации", пациент/субъект персональных данных дает свое согласие на предоставление в отношении него сведений, составляющих врачебную тайну в целях дальнейшего уведомления заказчика о результатах исследования с использованием федеральной государственной информационной системы "Единый портал государственных и муниципальных услуг" на наличие возбудителя коронавирусной инфекции (COVID-19) методом полимеразной цепной реакции, на наличие антител к возбудителю коронавирусной инфекции (COVID-19) (любым из методов), на наличие антител после вакцинации путем определения специальными тестами. |

| **Вопросы физ. лиц** |
| --- |
| Как мне понять, что результат анализа готов. | Пользователи портала могут получать на Госуслугах уведомления о готовности результатов. Результаты будут загружаться в виде QR-кода в мобильное приложение "Госуслуги Стопкоронавирус". Приложение нужно скачать. |
| При каких условиях я могу посмотреть результаты на Госуслугах. | Получать результаты исследований через Госуслуги могут пациенты, зарегистрированные на портале, данные которых при заказе (ФИО, дата рождения, паспортные данные, телефон, адрес электронной почты) совпадают с указанными в личном кабинете на портале Госуслуг. |
| Как поступают данные? | Идет выгрузка в ЦА РПН (центральный аппарат Роспотребнадзора) \&gt; данные поступают в ЕПГУ (Единый портал Государственных Услуг) \&gt; пользователю приходит уведомление в ГЭПС (Госпочта) и push следующего содержания: Результаты вашего теста на Covid-19 готовы и доступны в приложении "Госуслуги СТОП Коронавирус". |

Описание протокола интеграции для получения результатов по COVID. Версия: 3.4.2